<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Content Generator - App</title>
    <style>
        /* General Body Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            color: #333;
        }

        /* Container for the whole app */
        .container {
            max-width: 900px;
            margin: 20px auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Headings */
        h1, h2, h3 {
            color: #0056b3;
            text-align: center;
            margin-bottom: 20px;
        }

        /* Nav/Auth Links */
        .auth-links {
            text-align: right;
            margin-bottom: 20px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
        }
        /* Specific styling for the logout button */
        #logoutButton {
            background-color: #dc3545; /* Red color for logout */
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease; /* Smooth transition on hover */
        }
        #logoutButton:hover {
            background-color: #c82333; /* Darker red on hover */
        }


        /* Shared Form Styling (for generation) */
        input[type="text"], input[type="file"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box; /* Include padding in width */
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            width: 100%;
            box-sizing: border-box; /* Include padding in width */
            margin-top: 5px;
        }
        button:hover:not(:disabled) {
            opacity: 0.9;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* Section Specific Styles */
        .generation-section {
            background: #e9ecef;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        /* Message Display */
        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .message.info {
            background-color: #cfe2ff;
            color: #084298;
            border: 1px solid #b6d4fe;
        }

        /* Gallery Styles */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .gallery-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 350px;
        }
        .gallery-item img, .gallery-item video {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }
        .gallery-item .status-message {
            padding: 15px;
            background-color: #ffc107;
            color: #333;
            font-weight: bold;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .gallery-item .status-message.error {
            background-color: #dc3545;
            color: white;
        }
        .gallery-item .item-info {
            padding: 10px;
            margin-top: auto;
        }
        .gallery-item p {
            margin: 5px 0;
            font-size: 0.9em;
            color: #555;
        }
        .gallery-item .item-prompt {
            font-style: italic;
        }
        .gallery-item .item-date {
            font-size: 0.8em;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="auth-links">
            <span id="welcomeMessage">Welcome to the App!</span>
            <button id="logoutButton">Logout</button>
        </div>

        <h1>AI Content Generator</h1>

        <div>
            <div class="generation-section">
                <h3>Generate Image from Text</h3>
                <input type="text" id="imagePrompt" placeholder="Enter your prompt for image (e.g., 'a cat in space')">
                <button id="generateImageBtn">Generate Image</button>
            </div>

            <div class="generation-section">
                <h3>Generate Video from Text</h3>
                <input type="text" id="videoTextPrompt" placeholder="Enter your prompt for video (e.g., 'a futuristic city at night')">
                <button id="generateVideoFromTextBtn">Generate Video</button>
            </div>

            <div class="generation-section">
                <h3>Generate Video from File (e.g., image to 5s video)</h3>
                <input type="file" id="videoFile">
                <button id="generateVideoFromFileBtn">Generate Video from File</button>
            </div>

            <p class="message" id="generalStatusMessage"></p>

            <h2>Your Gallery</h2>
            <div class="gallery-grid" id="galleryContainer">
                <p id="galleryEmptyMessage" style="text-align: center; width: 100%; display: none;">No generated content yet. Start generating!</p>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const logoutButton = document.getElementById('logoutButton');
        const imagePromptInput = document.getElementById('imagePrompt');
        const generateImageBtn = document.getElementById('generateImageBtn');

        // New DOM elements for video from text
        const videoTextPromptInput = document.getElementById('videoTextPrompt');
        const generateVideoFromTextBtn = document.getElementById('generateVideoFromTextBtn');

        const videoFileInput = document.getElementById('videoFile');
        const generateVideoFromFileBtn = document.getElementById('generateVideoFromFileBtn');
        const generalStatusMessage = document.getElementById('generalStatusMessage');
        const galleryContainer = document.getElementById('galleryContainer');
        const galleryEmptyMessage = document.getElementById('galleryEmptyMessage');

        // --- Event Listeners ---

        logoutButton.addEventListener('click', async () => {
            try {
                const res = await fetch('/api/logout', { method: 'POST' });
                const data = await res.json();
                if (res.ok && data.success) {
                    generalStatusMessage.className = 'message success';
                    generalStatusMessage.textContent = data.msg;
                    setTimeout(() => {
                        window.location.href = '/login'; // Redirect to login page after logout
                    }, 500);
                } else {
                    generalStatusMessage.className = 'message error';
                    generalStatusMessage.textContent = data.msg || 'Logout failed.';
                }
            } catch (error) {
                console.error('Logout error:', error);
                generalStatusMessage.className = 'message error';
                generalStatusMessage.textContent = 'An error occurred during logout.';
            }
        });

        generateImageBtn.addEventListener('click', async () => {
            const prompt = imagePromptInput.value.trim();
            if (!prompt) {
                generalStatusMessage.className = 'message error';
                generalStatusMessage.textContent = 'Please enter a prompt.';
                return;
            }

            generalStatusMessage.className = 'message info';
            generalStatusMessage.textContent = 'Generating image... This may take a moment.';
            generateImageBtn.disabled = true;

            try {
                const res = await fetch('/api/generate/image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                const data = await res.json();
                if (res.ok && data.success) {
                    generalStatusMessage.className = 'message success';
                    generalStatusMessage.textContent = data.msg;
                    await fetchGallery(); // Refresh gallery immediately to show 'pending' status
                } else {
                    generalStatusMessage.className = 'message error';
                    generalStatusMessage.textContent = data.msg || 'Image generation failed.';
                }
            } catch (error) {
                console.error('Image generation error:', error);
                generalStatusMessage.className = 'message error';
                generalStatusMessage.textContent = 'An error occurred during image generation.';
            } finally {
                generateImageBtn.disabled = false;
            }
        });

        // NEW EVENT LISTENER: Generate Video from Text
        generateVideoFromTextBtn.addEventListener('click', async () => {
            const prompt = videoTextPromptInput.value.trim();
            if (!prompt) {
                generalStatusMessage.className = 'message error';
                generalStatusMessage.textContent = 'Please enter a prompt for video generation.';
                return;
            }

            generalStatusMessage.className = 'message info';
            generalStatusMessage.textContent = 'Generating video from text... This may take a moment.';
            generateVideoFromTextBtn.disabled = true;

            try {
                const res = await fetch('/api/generate/video/text', { // New API endpoint
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                const data = await res.json();
                if (res.ok && data.success) {
                    generalStatusMessage.className = 'message success';
                    generalStatusMessage.textContent = data.msg;
                    await fetchGallery(); // Refresh gallery immediately to show 'pending' status
                } else {
                    generalStatusMessage.className = 'message error';
                    generalStatusMessage.textContent = data.msg || 'Video generation from text failed.';
                }
            } catch (error) {
                console.error('Video generation from text error:', error);
                generalStatusMessage.className = 'message error';
                generalStatusMessage.textContent = 'An error occurred during video generation from text.';
            } finally {
                generateVideoFromTextBtn.disabled = false;
            }
        });

        generateVideoFromFileBtn.addEventListener('click', async () => {
            const file = videoFileInput.files[0];
            if (!file) {
                generalStatusMessage.className = 'message error';
                generalStatusMessage.textContent = 'Please select a file.';
                return;
            }

            const formData = new FormData();
            formData.append('sourceFile', file);

            generalStatusMessage.className = 'message info';
            generalStatusMessage.textContent = 'Generating video from file... This may take a moment.';
            generateVideoFromFileBtn.disabled = true;

            try {
                const res = await fetch('/api/generate/video/file', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (res.ok && data.success) {
                    generalStatusMessage.className = 'message success';
                    generalStatusMessage.textContent = data.msg;
                    await fetchGallery(); // Refresh gallery immediately to show 'pending' status
                } else {
                    generalStatusMessage.className = 'message error';
                    generalStatusMessage.textContent = data.Ldata.msg || 'Video generation failed.';
                }
            } catch (error) {
                console.error('Video generation error:', error);
                generalStatusMessage.className = 'message error';
                generalStatusMessage.textContent = 'An error occurred during video generation.';
            } finally {
                generateVideoFromFileBtn.disabled = false;
            }
        });

        // --- Gallery Functions ---

        async function fetchGallery() {
            try {
                const res = await fetch('/api/gallery');
                // Check for unauthorized access (e.g., if token expired while on page)
                if (res.status === 401) {
                    window.location.href = '/login'; // Redirect to login if unauthorized
                    return;
                }
                const data = await res.json();
                if (res.ok && data.success) {
                    renderGallery(data.gallery);
                } else {
                    generalStatusMessage.className = 'message error';
                    generalStatusMessage.textContent = data.msg || 'Failed to load gallery.';
                    galleryContainer.innerHTML = '';
                    galleryEmptyMessage.style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching gallery:', error);
                generalStatusMessage.className = 'message error';
                generalStatusMessage.textContent = 'An error occurred fetching gallery.';
                galleryContainer.innerHTML = '';
                galleryEmptyMessage.style.display = 'block';
            }
        }

        function renderGallery(items) {
            galleryContainer.innerHTML = ''; // Clear previous items
            if (items.length === 0) {
                galleryEmptyMessage.style.display = 'block';
                return;
            } else {
                galleryEmptyMessage.style.display = 'none';
            }

            items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'gallery-item';

                let mediaElement;
                if (item.status === 'completed') {
                    const mediaPath = `/${item.filePath}`;
                    if (item.type === 'image') {
                        mediaElement = document.createElement('img');
                        mediaElement.src = mediaPath;
                        mediaElement.alt = item.prompt || 'Generated Image';
                    } else if (item.type === 'video') {
                        mediaElement = document.createElement('video');
                        mediaElement.controls = true;
                        mediaElement.innerHTML = `<source src="${mediaPath}" type="video/mp4">Your browser does not support the video tag.`;
                    }
                } else {
                    mediaElement = document.createElement('div');
                    mediaElement.className = `status-message ${item.status === 'failed' ? 'error' : ''}`;
                    mediaElement.textContent = item.status === 'pending' ? 'Generating...' : 'Generation Failed';
                }

                if (mediaElement) {
                    itemDiv.appendChild(mediaElement);
                }

                const infoDiv = document.createElement('div');
                infoDiv.className = 'item-info';

                const promptPara = document.createElement('p');
                promptPara.className = 'item-prompt';
                promptPara.textContent = `Prompt: ${item.prompt || 'N/A'}`;
                infoDiv.appendChild(promptPara);

                const datePara = document.createElement('p');
                datePara.className = 'item-date';
                datePara.textContent = `Generated: ${new Date(item.createdAt).toLocaleDateString()}`;
                infoDiv.appendChild(datePara);

                itemDiv.appendChild(infoDiv);
                galleryContainer.appendChild(itemDiv);
            });
        }

        // --- Initial Load and Polling ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchGallery(); // Fetch gallery on initial load

            // Periodically refresh gallery to show status updates
            setInterval(fetchGallery, 10000); // Refresh every 10 seconds
        });
    </script>
</body>
</html>



